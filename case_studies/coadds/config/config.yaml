defaults:
    - _self_
    - training:
    - override hydra/job_logging: stdout

# completely disable hydra logging
# https://github.com/facebookresearch/hydra/issues/910
hydra:
    output_subdir: null
    run:
        dir: .

mode: train

gpus: 1 # use a single gpu by default.

paths:
    root: ${oc.env:BLISS_HOME}
    sdss: ${paths.root}/data/sdss
    data: ${paths.root}/data
    project: ${paths.root}/case_studies/coadds
    output: ${paths.project}/output

datasets:
    sdss_galaxies_coadd:
        _target_: case_studies.coadds.coadd_decoder.CoaddGalsimBlends
        prior:
            _target_: bliss.models.galsim_decoder.SingleGalsimGalaxyPrior
            flux_sample: "pareto"
            min_flux: 622.0
            max_flux: 1e6
            alpha: 0.47
            a_sample: "gamma"
            a_concentration: 0.39330758068481686
            a_loc: 0.8371888967872619
            a_scale: 4.432725319432478
            a_bulge_disk_ratio: 2.0
        decoder:
            _target_: case_studies.coadds.coadd_decoder.CoaddSingleGalaxyDecoder
            n_bands: 1
            slen: 53
            pixel_scale: 0.396
            psf_image_file: ${paths.sdss}/psField-000094-1-0012-PSF-image.npy
        background:
            _target_: bliss.datasets.background.ConstantBackground
            background:
                - 865.0
        tile_slen: 4
        max_sources_per_tile: 1
        num_workers: 32
        batch_size: 32
        n_batches: 10
        fix_validation_set: True
        valid_n_batches: 50
    galsim_blended_galaxies_coadd:
        _target_: case_studies.coadds.coadd_decoder.CoaddGalsimBlends
        prior:
            _target_: case_studies.coadds.coadd_decoder.CoaddUniformGalsimPrior
            single_galaxy_prior: ${datasets.sdss_galaxies_coadd.prior}
            max_n_sources: 6
            max_shift: 0.5
            n_dithers: 10
            galaxy_prob: 1.0
        decoder:
            _target_: case_studies.coadds.coadd_decoder.CoaddFullCatalogDecoder
            single_galaxy_decoder: ${datasets.sdss_galaxies_coadd.decoder}
            slen: 40
            bp: 24
            dithers: 5
        background: ${datasets.sdss_galaxies_coadd.background}
        tile_slen: 4
        max_sources_per_tile: 1
        num_workers: 10
        batch_size: 32
        n_batches: 10
        fix_validation_set: True
        valid_n_batches: 50
models:
    detection_encoder:
        _target_: bliss.models.detection_encoder.DetectionEncoder
        input_transform:
            _target_: bliss.models.detection_encoder.ConcatBackgroundTransform
        n_bands: 1
        tile_slen: 4
        ptile_slen: 52
        mean_detections: 0.03
        max_detections: 1
        channel: 8
        spatial_dropout: 0.0
        dropout: 0.0
        hidden: 128
        annotate_probs: True
        slack: 1.0
    galaxy_net:
        _target_: bliss.models.galaxy_net.OneCenteredGalaxyAE
        slen: 53
        latent_dim: 8
        hidden: 256
        n_bands: 1
    prior:
        _target_: bliss.models.prior.ImagePrior
        n_bands: 1
        max_sources: 1
        mean_sources: 0.03
        min_sources: 0
        f_min: 622.0
        f_max: 1e6
        alpha: 0.43
        prob_galaxy: 0.7
        galaxy_prior:
            _target_: bliss.models.prior.GalaxyPrior
            n_latent_batches: 160
            autoencoder: ${models.galaxy_net}
            autoencoder_ckpt: ${paths.project}/models/sdss_autoencoder.pt
            latents_file: ${paths.project}/models/latents_simulated_sdss_galaxies.pt
            psf_image_file: ${paths.sdss}/psField-000094-1-0012-PSF-image.npy
            galaxy_dataset: ${datasets.sdss_galaxies}
