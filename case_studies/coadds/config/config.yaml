defaults:
    - _self_
    - training:
    - override hydra/job_logging: stdout

hydra:
    output_subdir: null
    run:
        dir: .

mode: train

paths:
    root: ${oc.env:BLISS_HOME}
    sdss: ${paths.root}/data/sdss
    data: ${paths.root}/data
    project: ${paths.root}/case_studies/coadds
    output: ${paths.project}/output

seed: 42

datasets:
    galsim_blends:
        _target_: bliss.datasets.galsim_galaxies.GalsimBlends
        prior:
            _target_: bliss.models.galsim_decoder.UniformGalsimPrior
            single_galaxy_prior:
                _target_: bliss.models.galsim_decoder.SingleGalsimGalaxyPrior
                flux_sample: "pareto"
                min_flux: 622.0
                max_flux: 1e6
                alpha: 0.47
                a_sample: "gamma"
                a_concentration: 0.39330758068481686
                a_loc: 0.8371888967872619
                a_scale: 4.432725319432478
                a_bulge_disk_ratio: 2.0
            max_n_sources: 8
            mean_sources: 3
            max_shift: 0.5
            galaxy_prob: 0.0
        decoder:
            _target_: bliss.models.galsim_decoder.FullCatalogDecoder
            single_galaxy_decoder:
                _target_: bliss.models.galsim_decoder.SingleGalsimGalaxyDecoder
                n_bands: 1
                slen: 53
                pixel_scale: 0.396
                psf_params_file: ${paths.data}/sdss/94/1/12/psField-000094-1-0012.fits
                psf_slen: 25
                psf_gauss_fwhm: null
                sdss_bands:
                    - 2
            slen: 40
            bp: 24
        background:
            _target_: bliss.datasets.background.ConstantBackground
            background:
                - 865.0
        tile_slen: 4
        max_sources_per_tile: 1
        num_workers: 10
        batch_size: 32
        n_batches: 10
        fix_validation_set: True
        valid_n_batches: 200
    galsim_blends_coadds:
        _target_: case_studies.coadds.coadds.CoaddGalsimBlends
        prior:
            _target_: case_studies.coadds.coadds.CoaddUniformGalsimPrior
            single_galaxy_prior: ${datasets.galsim_blends.prior.single_galaxy_prior}
            max_n_sources: 8
            mean_sources: 3
            max_shift: 0.5
            galaxy_prob: 0.0
            n_dithers: 10
        decoder:
            _target_: case_studies.coadds.coadds.CoaddFullCatalogDecoder
            single_galaxy_decoder: ${datasets.galsim_blends.decoder.single_galaxy_decoder}
            slen: 40
            bp: 25 # needs to be 24+1 to account for padding
        background: ${datasets.galsim_blends.background}
        tile_slen: 4
        max_sources_per_tile: 1
        num_workers: 10
        batch_size: 32
        n_batches: 10
        fix_validation_set: False
        valid_n_batches: 200
    saved_coadd_module:
        _target_: case_studies.coadds.coadds.SavedCoaddsModule
        train_ds:
            _target_: case_studies.coadds.coadds.SavedCoadds
            dataset_file: ${paths.project}/output/datasets/${seed}/train.pt
            coadd_name: null
            background: ${datasets.galsim_blends.background}
            epoch_size: 10000
        val_ds:
            _target_: case_studies.coadds.coadds.SavedCoadds
            dataset_file: ${paths.project}/output/datasets/${seed}/val.pt
            coadd_name: null
            background: ${datasets.galsim_blends.background}
            epoch_size: 10000
        batch_size: 32

models:
    detection_encoder:
        _target_: bliss.models.detection_encoder.DetectionEncoder
        input_transform:
            _target_: bliss.models.detection_encoder.ConcatBackgroundTransform
        n_bands: 1
        tile_slen: 4
        ptile_slen: 52
        max_detections: 1
        channel: 8
        spatial_dropout: 0.0
        dropout: 0.0
        hidden: 128
        annotate_probs: True
        slack: 1.0

training:
    n_epochs: 1001
    experiment: encoder
    name: null
    version: null
    save_top_k: 3
    trainer:
        _target_: pytorch_lightning.Trainer
        logger: True
        enable_checkpointing: True
        profiler: null
        reload_dataloaders_every_n_epochs: 0
        max_epochs: ${training.n_epochs}
        min_epochs: ${training.n_epochs}
        accelerator: "gpu"
        devices: 1
        limit_train_batches: 1.0
        limit_val_batches: 1.0
        check_val_every_n_epoch: 10
        log_every_n_steps: 10 # correspond to n_batches
    testing:
        file: null
        batch_size: 32
        num_workers: 0
    seed: null
    weight_save_path: ${paths.project}/output/weights/${seed}/${training.name}_${training.seed}.pt
    model: ${models.detection_encoder}
    dataset: ${datasets.saved_coadd_module}
    optimizer_params:
        lr: 1e-4

get_data:
    seed: ${seed}
    type: train
    path: ${paths.output}/datasets/${seed}/

results:
    seeds: # used for training, should correspond to ones in `train.sh`
        - 1
        - 2
        - 3
        - 4
        - 5
    overwrite: False
    test_path: ${paths.project}/output/datasets/${seed}/test.pt
    cache_results: ${paths.project}/output/cache/${seed}/results.pt
    models_path: ${paths.project}/output/weights/${seed}
    figs_path: ${paths.project}/output/figs/${seed}/
    report_file: ${paths.project}/output/figs/${seed}/report.txt
    figs:
        - money
        - calibration
    models:
        - "single"
        - "coadd_5"
        - "coadd_10"
        - "coadd_25"
    mag_bins:
        - 20
        - 23
        - 0.2
