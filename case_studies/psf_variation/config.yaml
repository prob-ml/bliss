---
defaults:
    - ../../bliss/conf@_here_: base_config
    - _self_
    - override hydra/job_logging: stdout

paths:
    sdss: /data/scratch/sdss
    cached_data: /data/scratch/aakash

encoder:
    survey_bands: ["u", "g", "r", "i", "z"]
    reference_band: 2  # SDSS r-band
    min_flux_for_loss: 1.59  # 22 magnitude (0.63 is 23 mag; 0.25 is 24 mag)
    min_flux_for_metrics: 1.59

variational_factors:
    - _target_: bliss.encoder.variational_dist.BernoulliFactor
      name: n_sources
      sample_rearrange: null
      nll_rearrange: null
      nll_gating: null
    - _target_: bliss.encoder.variational_dist.TDBNFactor
      name: locs
      sample_rearrange: "b ht wt d -> b ht wt 1 d"
      nll_rearrange: "b ht wt 1 d -> b ht wt d"
      nll_gating: n_sources
    - _target_: bliss.encoder.variational_dist.BernoulliFactor
      name: source_type
      sample_rearrange: "b ht wt -> b ht wt 1 1"
      nll_rearrange: "b ht wt 1 1 -> b ht wt"
      nll_gating: n_sources
    - _target_: bliss.encoder.variational_dist.LogNormalFactor
      name: star_fluxes
      dim: 5
      sample_rearrange: "b ht wt d -> b ht wt 1 d"
      nll_rearrange: "b ht wt 1 d -> b ht wt d"
      nll_gating: is_star
    - _target_: bliss.encoder.variational_dist.LogNormalFactor
      name: galaxy_fluxes
      dim: 5
      sample_rearrange: "b ht wt d -> b ht wt 1 d"
      nll_rearrange: "b ht wt 1 d -> b ht wt d"
      nll_gating: is_galaxy

metrics:
    detection_performance:
        _target_: bliss.encoder.metrics.DetectionPerformance
        mag_bin_cutoffs: [19, 19.4, 19.8, 20.2, 20.6, 21, 21.4, 21.8]
        mag_band: 2
    source_type_accuracy:
        _target_: bliss.encoder.metrics.SourceTypeAccuracy
        flux_bin_cutoffs: [200, 400, 600, 800, 1000]
    flux_error:
        _target_: bliss.encoder.metrics.FluxError
        survey_bands: ${encoder.survey_bands}

image_normalizers:
    psf:
        _target_: bliss.encoder.image_normalizer.PsfAsImage
        num_psf_params: 6  # 6 for SDSS, 4 for DC2, 10 for DES
    asinh:
        _target_: bliss.encoder.image_normalizer.AsinhQuantileNormalizer
        q: [0.01, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 0.99, 0.999, 0.9999, 0.99999]

cached_simulator:
    cached_data_path: /data/scratch/aakash/multi_field_train
    batch_size: 64
    splits: 0:80/80:90/90:100  # train/val/test splits as percent ranges

surveys:
    sdss:
        fields:
            - run: 94
              camcol: 1
              fields: ${range:12,482,20}
            - run: 125
              camcol: 1
              fields: ${range:15,565,20,435}
            - run: 752
              camcol: 1
              fields: ${range:15,685,20}
            - run: 3900
              camcol: 6
              fields: ${range:16,596,20,76}

generate:
    n_image_files: 8
    n_batches_per_file: 16
    simulator: ${simulator}
    cached_data_path: ${paths.cached_data}/multi_field_train
    file_prefix: dataset
    store_full_catalog: false

train:
    trainer:
        logger:
            name: PSF_MODELS
            version: multi_field_psf_aware
    seed: 12345
