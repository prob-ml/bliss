---
defaults:
    - ../../bliss/conf@_here_: base_config
    - _self_
    - override hydra/job_logging: stdout


prior:
    _target_: case_studies.galaxy_clustering.prior.GalaxyClusterPrior
    survey_bands: ["u", "g", "r", "i", "z"]  # SDSS available band filters
    reference_band: 2  # SDSS r-band
    star_color_model_path: ${simulator.survey.dir_path}/color_models/star_gmm_nmgy.pkl
    gal_color_model_path: ${simulator.survey.dir_path}/color_models/gal_gmm_nmgy.pkl
    n_tiles_h: 56
    n_tiles_w: 56
    tile_slen: 128
    batch_size: 1
    max_sources: 6
    mean_sources: 0.48
    min_sources: 0
    prob_galaxy: 0.2
    star_flux_exponent: 0.9859821185389767
    star_flux_truncation: 5685.588160703261
    star_flux_loc: -1.162430157551662
    star_flux_scale: 1.4137911256506595

cached_simulator:
    _target_: bliss.cached_dataset.CachedSimulatedDataModule
    batch_size: 2
    splits: 0:60/60:90/90:100  # train/val/test splits as percent ranges
    num_workers: 8
    cached_data_path: /home/kapnadak/bliss/case_studies/galaxy_clustering/data/file_data
    train_transforms: []

train:
    trainer:
        precision: 32-true
        accumulate_grad_batches: 10

variational_factors:
    - _target_: bliss.encoder.variational_dist.BernoulliFactor
      name: membership
      sample_rearrange: "b ht wt -> b ht wt 1 1"
      nll_rearrange: "b ht wt 1 1 -> b ht wt"
      nll_gating: null

my_metrics:
  cluster_membership_acc:
    _target_: case_studies.galaxy_clustering.encoder.metrics.ClusterMembershipAccuracy

encoder:
    _target_: case_studies.galaxy_clustering.encoder.encoder.GalaxyClusterEncoder
    survey_bands: ["g", "r", "i", "z", "y"]
    image_normalizer:
        _target_: bliss.encoder.image_normalizer.ImageNormalizer
        bands: [0, 1, 2, 3, 4]
        include_original: true
        include_background: false
        concat_psf_params: false
        num_psf_params: 6  # for SDSS, 4 for DC2
        log_transform_stdevs: null
        use_clahe: false
        clahe_min_stdev: null
    metrics:
      _target_: torchmetrics.MetricCollection
      _convert_: "partial"
      metrics: ${my_metrics}
    var_dist:
        _target_: case_studies.galaxy_clustering.encoder.variational_dist.GalaxyClusterVariationalDist
        tile_slen: ${encoder.tile_slen}
        factors: ${variational_factors}
    use_checkerboard: false

predict:
    dataset: ${surveys.des}
    trainer:
        _target_: pytorch_lightning.Trainer
        accelerator: "gpu"
        precision: ${train.trainer.precision}
    encoder: ${encoder}
    weight_save_path: ${paths.output}/version_23/checkpoints/best_encoder.ckpt
    device: "cuda:0"
