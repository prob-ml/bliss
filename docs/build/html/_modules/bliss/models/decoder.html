
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bliss.models.decoder &#8212; bliss  documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for bliss.models.decoder</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torch.distributions</span> <span class="kn">import</span> <span class="n">Poisson</span><span class="p">,</span> <span class="n">Normal</span>
<span class="kn">import</span> <span class="nn">pytorch_lightning</span> <span class="k">as</span> <span class="nn">pl</span>

<span class="kn">from</span> <span class="nn">.encoder</span> <span class="kn">import</span> <span class="n">get_is_on_from_n_sources</span><span class="p">,</span> <span class="n">get_mgrid</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">galaxy_net</span>


<span class="k">def</span> <span class="nf">get_fit_file_psf_params</span><span class="p">(</span><span class="n">psf_fit_file</span><span class="p">,</span> <span class="n">bands</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)):</span>
    <span class="n">psfield</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">psf_fit_file</span><span class="p">,</span> <span class="n">ignore_missing_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">psf_params</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bands</span><span class="p">)):</span>
        <span class="n">band</span> <span class="o">=</span> <span class="n">bands</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">sigma1</span> <span class="o">=</span> <span class="n">psfield</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;psf_sigma1&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">band</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">sigma2</span> <span class="o">=</span> <span class="n">psfield</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;psf_sigma2&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">band</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">sigmap</span> <span class="o">=</span> <span class="n">psfield</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;psf_sigmap&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">band</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="n">beta</span> <span class="o">=</span> <span class="n">psfield</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;psf_beta&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">band</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">psfield</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;psf_b&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">band</span><span class="p">]</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="n">psfield</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;psf_p0&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">band</span><span class="p">]</span>

        <span class="n">psf_params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">sigma1</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">sigmap</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">p0</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">psf_params</span>


<div class="viewcode-block" id="ImageDecoder"><a class="viewcode-back" href="../../../api/bliss.models.html#bliss.models.decoder.ImageDecoder">[docs]</a><span class="k">class</span> <span class="nc">ImageDecoder</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n_bands</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">slen</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">tile_slen</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">ptile_slen</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">border_padding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">prob_galaxy</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">n_galaxy_params</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">max_sources</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">mean_sources</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="n">min_sources</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">f_min</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span>
        <span class="n">f_max</span><span class="o">=</span><span class="mf">1e6</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">gal_slen</span><span class="o">=</span><span class="mi">51</span><span class="p">,</span>
        <span class="n">psf_slen</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
        <span class="n">decoder_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">psf_params_file</span><span class="o">=</span><span class="s2">&quot;psf_params.npy&quot;</span><span class="p">,</span>
        <span class="n">background_values</span><span class="o">=</span><span class="p">(</span><span class="mf">686.0</span><span class="p">,</span> <span class="mf">1123.0</span><span class="p">),</span>
        <span class="n">loc_min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">loc_max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># side-length in pixels of an image (image is assumed to be square)</span>
        <span class="k">assert</span> <span class="n">slen</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;slen must be an integer.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">slen</span><span class="p">)</span>

        <span class="c1"># side-length of an image tile.</span>
        <span class="c1"># latent variables (locations, fluxes, etc) are drawn per-tile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tile_slen</span> <span class="o">=</span> <span class="n">tile_slen</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slen</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_slen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;We assume that the tiles cover the image.&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; So slen must be divisible by tile_slen&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Images are first rendered on *padded* tiles (aka ptiles).</span>
        <span class="c1"># The padded tile consists of the tile and neighboring tiles</span>
        <span class="c1"># The width of the padding is given by ptile_slen.</span>
        <span class="c1"># border_padding is the amount of padding we leave in the final image. Useful for</span>
        <span class="c1"># avoiding sources getting too close to the edges.</span>
        <span class="k">if</span> <span class="n">border_padding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># default value matches encoder default.</span>
            <span class="n">border_padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptile_slen</span> <span class="o">-</span> <span class="n">tile_slen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">n_tiles_of_padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptile_slen</span> <span class="o">/</span> <span class="n">tile_slen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">ptile_padding</span> <span class="o">=</span> <span class="n">n_tiles_of_padding</span> <span class="o">*</span> <span class="n">tile_slen</span>
        <span class="k">assert</span> <span class="n">border_padding</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;amount of border padding must be an integer&quot;</span>
        <span class="k">assert</span> <span class="n">n_tiles_of_padding</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;n_tiles_of_padding must be an integer&quot;</span>
        <span class="k">assert</span> <span class="n">border_padding</span> <span class="o">&lt;=</span> <span class="n">ptile_padding</span><span class="p">,</span> <span class="s2">&quot;Too much border, increase ptile_slen&quot;</span>
        <span class="k">assert</span> <span class="n">tile_slen</span> <span class="o">&lt;=</span> <span class="n">ptile_slen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">border_padding</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">border_padding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span> <span class="o">=</span> <span class="n">ptile_slen</span>

        <span class="c1"># number of tiles per image</span>
        <span class="n">n_tiles_per_image</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slen</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_slen</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_tiles_per_image</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_tiles_per_image</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span> <span class="o">=</span> <span class="n">n_bands</span>  <span class="c1"># number of bands</span>

        <span class="c1"># per-tile prior parameters on number (and type) of sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_sources</span> <span class="o">=</span> <span class="n">max_sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_sources</span> <span class="o">=</span> <span class="n">mean_sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_sources</span> <span class="o">=</span> <span class="n">min_sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob_galaxy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">prob_galaxy</span><span class="p">)</span>

        <span class="c1"># per-tile constraints on the location of sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc_min</span> <span class="o">=</span> <span class="n">loc_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loc_max</span> <span class="o">=</span> <span class="n">loc_max</span>

        <span class="c1"># prior parameters on fluxes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_min</span> <span class="o">=</span> <span class="n">f_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_max</span> <span class="o">=</span> <span class="n">f_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>  <span class="c1"># pareto parameter.</span>

        <span class="c1"># caching the underlying</span>
        <span class="c1"># coordinates on which we simulate source</span>
        <span class="c1"># grid: between -1 and 1,</span>
        <span class="c1"># then scale slightly because of the way f.grid_sample</span>
        <span class="c1"># parameterizes the edges: (0, 0) is center of edge pixel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span>
            <span class="s2">&quot;cached_grid&quot;</span><span class="p">,</span> <span class="n">get_mgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span><span class="p">),</span> <span class="n">persistent</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># misc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;swap&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">persistent</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># background</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">background_values</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_bands</span>
        <span class="n">background_shape</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slen</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">border_padding</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">slen</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">border_padding</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span>
            <span class="s2">&quot;background&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">background_shape</span><span class="p">),</span> <span class="n">persistent</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_bands</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">background_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># galaxy decoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_slen</span> <span class="o">=</span> <span class="n">gal_slen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_galaxy_params</span> <span class="o">=</span> <span class="n">n_galaxy_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galaxy_decoder</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_galaxy</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">decoder_file</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">decoder_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="n">galaxy_net</span><span class="o">.</span><span class="n">CenteredGalaxyDecoder</span><span class="p">(</span><span class="n">gal_slen</span><span class="p">,</span> <span class="n">n_galaxy_params</span><span class="p">,</span> <span class="n">n_bands</span><span class="p">)</span>
            <span class="n">dec</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">decoder_file</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
            <span class="n">dec</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">galaxy_decoder</span> <span class="o">=</span> <span class="n">dec</span>

        <span class="c1"># load psf params + grid</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">psf_params_file</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.npy&quot;</span><span class="p">:</span>
            <span class="n">psf_params</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">psf_params_file</span><span class="p">))</span>
            <span class="n">psf_params</span> <span class="o">=</span> <span class="n">psf_params</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_bands</span><span class="p">))]</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.fits&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">n_bands</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;only 2 band fit files are supported.&quot;</span>
            <span class="n">bands</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">psf_params</span> <span class="o">=</span> <span class="n">get_fit_file_psf_params</span><span class="p">(</span><span class="n">psf_params_file</span><span class="p">,</span> <span class="n">bands</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;Only .npy and .fits extensions are supported for PSF params files.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">psf_params</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_slen</span> <span class="o">=</span> <span class="n">psf_slen</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">get_mgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psf_slen</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psf_slen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="c1"># extra factor to be consistent with old repo</span>
        <span class="c1"># but probably doesn&#39;t matter ...</span>
        <span class="n">grid</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_slen</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psf_slen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;cached_radii_grid&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">grid</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sqrt</span><span class="p">())</span>

        <span class="c1"># get normalization_constant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalization_constant</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span><span class="p">):</span>
            <span class="n">psf_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_psf_single_band</span><span class="p">(</span><span class="n">psf_params</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">normalization_constant</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">psf_i</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalization_constant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalization_constant</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

<div class="viewcode-block" id="ImageDecoder.forward"><a class="viewcode-back" href="../../../api/bliss.models.html#bliss.models.decoder.ImageDecoder.forward">[docs]</a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_psf</span><span class="p">()</span>
        <span class="n">init_psf_sum</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">psf</span> <span class="o">*=</span> <span class="p">(</span><span class="n">init_psf_sum</span> <span class="o">/</span> <span class="n">norm</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">psf</span></div>

    <span class="k">def</span> <span class="nf">_get_psf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([],</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span><span class="p">):</span>
            <span class="n">_psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_psf_single_band</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">_psf</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalization_constant</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">psf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">psf</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="n">_psf</span><span class="p">),</span> <span class="n">_psf</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

        <span class="k">assert</span> <span class="p">(</span><span class="n">psf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">psf</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_psf_fun</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">sigma1</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">sigmap</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">p0</span><span class="p">):</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">r</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma1</span><span class="p">))</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">r</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma2</span><span class="p">))</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">r</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">sigmap</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">beta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">+</span> <span class="n">term3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">p0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_psf_single_band</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psf_params</span><span class="p">):</span>
        <span class="n">_psf_params</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">psf_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_psf_fun</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cached_radii_grid</span><span class="p">,</span>
            <span class="n">_psf_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">_psf_params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">_psf_params</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">_psf_params</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">_psf_params</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="n">_psf_params</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sample_n_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="c1"># returns number of sources for each batch x tile</span>
        <span class="c1"># output dimension is batch_size x n_tiles_per_image</span>

        <span class="c1"># always poisson distributed.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">1</span><span class="p">,),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_sources</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">Poisson</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">n_sources</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">sample</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_tiles_per_image</span><span class="p">])</span>

        <span class="c1"># long() here is necessary because used for indexing and one_hot encoding.</span>
        <span class="n">n_sources</span> <span class="o">=</span> <span class="n">n_sources</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_sources</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_sources</span><span class="p">)</span>
        <span class="n">n_sources</span> <span class="o">=</span> <span class="n">n_sources</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_tiles_per_image</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n_sources</span>

    <span class="k">def</span> <span class="nf">_sample_locs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_on_array</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="c1"># output dimension is batch_size x n_tiles_per_image x max_sources x 2</span>

        <span class="c1"># 2 = (x,y)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_tiles_per_image</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_sources</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">is_on_array</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">locs</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_min</span>
        <span class="n">locs</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loc_min</span>
        <span class="n">locs</span> <span class="o">*=</span> <span class="n">is_on_array</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">locs</span>

    <span class="k">def</span> <span class="nf">_sample_n_galaxies_and_stars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_sources</span><span class="p">,</span> <span class="n">is_on_array</span><span class="p">):</span>
        <span class="c1"># the counts returned (n_galaxies, n_stars) are of shape (batch_size x n_tiles_per_image)</span>
        <span class="c1"># the booleans returned (galaxy_bool, star_bool) are of shape</span>
        <span class="c1"># (batch_size x n_tiles_per_image x max_detections x 1)</span>
        <span class="c1"># this last dimension is so it is parallel to other galaxy/star params.</span>

        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">n_sources</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">uniform</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_tiles_per_image</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_sources</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">is_on_array</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">galaxy_bool</span> <span class="o">=</span> <span class="n">uniform</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_galaxy</span>
        <span class="n">galaxy_bool</span> <span class="o">=</span> <span class="p">(</span><span class="n">galaxy_bool</span> <span class="o">*</span> <span class="n">is_on_array</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">star_bool</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">galaxy_bool</span><span class="p">)</span> <span class="o">*</span> <span class="n">is_on_array</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">n_galaxies</span> <span class="o">=</span> <span class="n">galaxy_bool</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">n_stars</span> <span class="o">=</span> <span class="n">star_bool</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">n_stars</span> <span class="o">&lt;=</span> <span class="n">n_sources</span><span class="p">)</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">n_galaxies</span> <span class="o">&lt;=</span> <span class="n">n_sources</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">n_galaxies</span><span class="p">,</span> <span class="n">n_stars</span><span class="p">,</span> <span class="n">galaxy_bool</span><span class="p">,</span> <span class="n">star_bool</span>

    <span class="k">def</span> <span class="nf">_pareto_cdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_min</span> <span class="o">/</span> <span class="n">x</span><span class="p">)</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>

    <span class="k">def</span> <span class="nf">_draw_pareto_maxed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="c1"># draw pareto conditioned on being less than f_max</span>

        <span class="n">u_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pareto_cdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_max</span><span class="p">)</span>
        <span class="n">uniform_samples</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="o">*</span> <span class="n">u_max</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_min</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">uniform_samples</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_sample_fluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_stars</span><span class="p">,</span> <span class="n">star_bool</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            fluxes, tensor shape (batch_size x self.n_tiles_per_image x self.max_sources x n_bands)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">n_stars</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">batch_size</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_tiles_per_image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sources</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">base_fluxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_pareto_maxed</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">batch_size</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_tiles_per_image</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_sources</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">base_fluxes</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">_fluxes</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">colors</span> <span class="o">/</span> <span class="mf">2.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">base_fluxes</span>
            <span class="n">fluxes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">base_fluxes</span><span class="p">,</span> <span class="n">_fluxes</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">fluxes</span> <span class="o">*=</span> <span class="n">star_bool</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fluxes</span> <span class="o">=</span> <span class="n">base_fluxes</span> <span class="o">*</span> <span class="n">star_bool</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">fluxes</span>

    <span class="k">def</span> <span class="nf">_sample_galaxy_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_galaxies</span><span class="p">,</span> <span class="n">galaxy_bool</span><span class="p">):</span>
        <span class="c1"># galaxy params are just Normal(0,1) variables.</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_galaxies</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">n_galaxies</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">n_galaxies</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">n_galaxies</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">p_z</span> <span class="o">=</span> <span class="n">Normal</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_tiles_per_image</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_sources</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_galaxy_params</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">sample_shape</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">galaxy_params</span> <span class="o">=</span> <span class="n">p_z</span><span class="o">.</span><span class="n">rsample</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">)</span>
        <span class="n">galaxy_params</span> <span class="o">=</span> <span class="n">galaxy_params</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># zero out excess according to galaxy_bool.</span>
        <span class="n">galaxy_params</span> <span class="o">=</span> <span class="n">galaxy_params</span> <span class="o">*</span> <span class="n">galaxy_bool</span>
        <span class="k">return</span> <span class="n">galaxy_params</span>

    <span class="k">def</span> <span class="nf">sample_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">n_sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_n_sources</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="n">is_on_array</span> <span class="o">=</span> <span class="n">get_is_on_from_n_sources</span><span class="p">(</span><span class="n">n_sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_sources</span><span class="p">)</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_locs</span><span class="p">(</span><span class="n">is_on_array</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>

        <span class="n">n_galaxies</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">galaxy_bool</span><span class="p">,</span> <span class="n">star_bool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_n_galaxies_and_stars</span><span class="p">(</span>
            <span class="n">n_sources</span><span class="p">,</span> <span class="n">is_on_array</span>
        <span class="p">)</span>
        <span class="n">galaxy_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_galaxy_params</span><span class="p">(</span><span class="n">n_galaxies</span><span class="p">,</span> <span class="n">galaxy_bool</span><span class="p">)</span>
        <span class="n">fluxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sample_fluxes</span><span class="p">(</span><span class="n">n_sources</span><span class="p">,</span> <span class="n">star_bool</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="n">log_fluxes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_log_fluxes</span><span class="p">(</span><span class="n">fluxes</span><span class="p">)</span>

        <span class="c1"># per tile quantities.</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;n_sources&quot;</span><span class="p">:</span> <span class="n">n_sources</span><span class="p">,</span>
            <span class="s2">&quot;locs&quot;</span><span class="p">:</span> <span class="n">locs</span><span class="p">,</span>
            <span class="s2">&quot;galaxy_bool&quot;</span><span class="p">:</span> <span class="n">galaxy_bool</span><span class="p">,</span>
            <span class="s2">&quot;galaxy_params&quot;</span><span class="p">:</span> <span class="n">galaxy_params</span><span class="p">,</span>
            <span class="s2">&quot;fluxes&quot;</span><span class="p">:</span> <span class="n">fluxes</span><span class="p">,</span>
            <span class="s2">&quot;log_fluxes&quot;</span><span class="p">:</span> <span class="n">log_fluxes</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_log_fluxes</span><span class="p">(</span><span class="n">fluxes</span><span class="p">):</span>
        <span class="n">log_fluxes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">fluxes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fluxes</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">fluxes</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># prevent log(0) errors.</span>
        <span class="n">log_fluxes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">log_fluxes</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">log_fluxes</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_apply_noise</span><span class="p">(</span><span class="n">images_mean</span><span class="p">):</span>
        <span class="c1"># add noise to images.</span>

        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">images_mean</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;image mean less than 0&quot;</span><span class="p">)</span>
            <span class="n">images_mean</span> <span class="o">=</span> <span class="n">images_mean</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">_images</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">images_mean</span><span class="p">)</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">_images</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">images_mean</span><span class="p">)</span>
        <span class="n">images</span> <span class="o">=</span> <span class="n">images</span> <span class="o">+</span> <span class="n">images_mean</span>

        <span class="k">return</span> <span class="n">images</span>

    <span class="k">def</span> <span class="nf">_trim_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Crop the source to length ptile_slen x ptile_slen, centered at the middle.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>

        <span class="c1"># if self.ptile_slen is even, we still make source dimension odd.</span>
        <span class="c1"># otherwise, the source won&#39;t have a peak in the center pixel.</span>
        <span class="n">_slen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span> <span class="o">+</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>

        <span class="n">source_slen</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">source_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">source_slen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="k">assert</span> <span class="n">source_slen</span> <span class="o">&gt;=</span> <span class="n">_slen</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">_slen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">l_indx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">source_center</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">u_indx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">source_center</span> <span class="o">+</span> <span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">source</span><span class="p">[:,</span> <span class="n">l_indx</span><span class="p">:</span><span class="n">u_indx</span><span class="p">,</span> <span class="n">l_indx</span><span class="p">:</span><span class="n">u_indx</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_expand_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pad the source with zeros so that it is size ptile_slen,&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>

        <span class="n">_slen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span> <span class="o">+</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>

        <span class="n">source_slen</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">source_slen</span> <span class="o">&lt;=</span> <span class="n">_slen</span><span class="p">,</span> <span class="s2">&quot;Should be using trim source.&quot;</span>

        <span class="n">source_expanded</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_slen</span><span class="p">,</span> <span class="n">_slen</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">_slen</span> <span class="o">-</span> <span class="n">source_slen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">source_expanded</span><span class="p">[</span>
            <span class="p">:,</span> <span class="n">offset</span> <span class="p">:</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">source_slen</span><span class="p">),</span> <span class="n">offset</span> <span class="p">:</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">source_slen</span><span class="p">)</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">source</span>

        <span class="k">return</span> <span class="n">source_expanded</span>

    <span class="k">def</span> <span class="nf">_adjust_psf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># use power_law_psf and current psf parameters to forward and obtain fresh psf model.</span>
        <span class="c1"># first dimension of psf is number of bands</span>
        <span class="c1"># dimension of the psf/slen should be odd</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">()</span>
        <span class="n">psf_slen</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">assert</span> <span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">psf_slen</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">psf_slen</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span> <span class="o">&gt;=</span> <span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_source</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trim_source</span><span class="p">(</span><span class="n">psf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_size_galaxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">galaxy</span><span class="p">):</span>
        <span class="c1"># galaxy should be shape n_galaxies x n_bands x galaxy_slen x galaxy_slen</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">galaxy</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
        <span class="k">assert</span> <span class="n">galaxy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">galaxy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">galaxy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;dimension of galaxy image should be odd&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">galaxy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span>

        <span class="n">n_galaxies</span> <span class="o">=</span> <span class="n">galaxy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">galaxy_slen</span> <span class="o">=</span> <span class="n">galaxy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">galaxy</span> <span class="o">=</span> <span class="n">galaxy</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_galaxies</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span><span class="p">,</span> <span class="n">galaxy_slen</span><span class="p">,</span> <span class="n">galaxy_slen</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span> <span class="o">&gt;=</span> <span class="n">galaxy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">sized_galaxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_source</span><span class="p">(</span><span class="n">galaxy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sized_galaxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trim_source</span><span class="p">(</span><span class="n">galaxy</span><span class="p">)</span>

        <span class="n">outsize</span> <span class="o">=</span> <span class="n">sized_galaxy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sized_galaxy</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_galaxies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span><span class="p">,</span> <span class="n">outsize</span><span class="p">,</span> <span class="n">outsize</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_render_one_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locs</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param locs: is n_ptiles x len((x,y))</span>
<span class="sd">        :param source: is a (n_ptiles, n_bands, slen, slen) tensor, which could either be a</span>
<span class="sd">                        `expanded_psf` (psf repeated multiple times) for the case of of stars.</span>
<span class="sd">                        Or multiple galaxies in the case of galaxies.</span>
<span class="sd">        :return: shape = (n_ptiles x n_bands x slen x slen)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_ptiles</span> <span class="o">=</span> <span class="n">locs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_ptiles</span>
        <span class="k">assert</span> <span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span>
        <span class="k">assert</span> <span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">locs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>

        <span class="c1"># scale so that they land in the tile within the padded tile</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_slen</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="n">locs</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_slen</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">padding</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span><span class="p">)</span>
        <span class="c1"># scale locs so they take values between -1 and 1 for grid sample</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="p">(</span><span class="n">locs</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">_grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_grid</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">locs_swapped</span> <span class="o">=</span> <span class="n">locs</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">swap</span><span class="p">)</span>
        <span class="n">grid_loc</span> <span class="o">=</span> <span class="n">_grid</span> <span class="o">-</span> <span class="n">locs_swapped</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_ptiles</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">source_rendered</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">grid_loc</span><span class="p">,</span> <span class="n">align_corners</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">source_rendered</span>

    <span class="k">def</span> <span class="nf">_render_multiple_stars_on_ptile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locs</span><span class="p">,</span> <span class="n">fluxes</span><span class="p">,</span> <span class="n">star_bool</span><span class="p">):</span>
        <span class="c1"># locs: is (n_ptiles x max_num_stars x 2)</span>
        <span class="c1"># fluxes: Is (n_ptiles x n_bands x max_stars)</span>
        <span class="c1"># star_bool: Is (n_ptiles x max_stars x 1)</span>
        <span class="c1"># max_sources obtained from locs, allows for more flexibility when rendering.</span>

        <span class="n">psf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adjust_psf</span><span class="p">()</span>
        <span class="n">n_ptiles</span> <span class="o">=</span> <span class="n">locs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_sources</span> <span class="o">=</span> <span class="n">locs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ptile_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_ptiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span><span class="p">)</span>
        <span class="n">ptile</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ptile_shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">locs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>  <span class="c1"># the shape is (n_bands, ptile_slen, ptile_slen)</span>
        <span class="k">assert</span> <span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span>
        <span class="k">assert</span> <span class="n">fluxes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">star_bool</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_ptiles</span>
        <span class="k">assert</span> <span class="n">fluxes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">star_bool</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_sources</span>
        <span class="k">assert</span> <span class="n">fluxes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">psf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span>
        <span class="k">assert</span> <span class="n">star_bool</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="c1"># all stars are just the PSF so we copy it.</span>
        <span class="n">expanded_psf</span> <span class="o">=</span> <span class="n">psf</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">n_ptiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># this loop plots each of the ith star in each of the (n_ptiles) images.</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_sources</span><span class="p">):</span>
            <span class="n">star_bool_n</span> <span class="o">=</span> <span class="n">star_bool</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span>
            <span class="n">locs_n</span> <span class="o">=</span> <span class="n">locs</span><span class="p">[:,</span> <span class="n">n</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">fluxes_n</span> <span class="o">=</span> <span class="n">fluxes</span><span class="p">[:,</span> <span class="n">n</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">star_bool_n</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">fluxes_n</span> <span class="o">=</span> <span class="n">fluxes_n</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_ptiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">one_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_one_source</span><span class="p">(</span><span class="n">locs_n</span><span class="p">,</span> <span class="n">expanded_psf</span><span class="p">)</span>
            <span class="n">ptile</span> <span class="o">+=</span> <span class="n">one_star</span> <span class="o">*</span> <span class="n">fluxes_n</span>

        <span class="k">return</span> <span class="n">ptile</span>

    <span class="k">def</span> <span class="nf">_render_single_galaxies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">galaxy_params</span><span class="p">,</span> <span class="n">galaxy_bool</span><span class="p">):</span>

        <span class="c1"># flatten parameters</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">galaxy_params</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_galaxy_params</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">galaxy_bool</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c1"># allocate memory</span>
        <span class="n">_slen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span> <span class="o">+</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>
        <span class="n">gal</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span><span class="p">,</span> <span class="n">_slen</span><span class="p">,</span> <span class="n">_slen</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">galaxy_params</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span><span class="p">,</span> <span class="n">_slen</span><span class="p">,</span> <span class="n">_slen</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">galaxy_params</span><span class="o">.</span><span class="n">device</span>
        <span class="p">)</span>

        <span class="c1"># forward only galaxies that are on!</span>
        <span class="n">gal_on</span><span class="p">,</span> <span class="n">var_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">galaxy_decoder</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">b</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>

        <span class="c1"># size the galaxy (either trims or crops to the size of ptile)</span>
        <span class="n">gal_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size_galaxy</span><span class="p">(</span><span class="n">gal_on</span><span class="p">)</span>
        <span class="n">var_on</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_size_galaxy</span><span class="p">(</span><span class="n">var_on</span><span class="p">)</span>

        <span class="c1"># set galaxies</span>
        <span class="n">gal</span><span class="p">[</span><span class="n">b</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gal_on</span>
        <span class="n">var</span><span class="p">[</span><span class="n">b</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_on</span>

        <span class="n">batchsize</span> <span class="o">=</span> <span class="n">galaxy_params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">gal_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">batchsize</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span><span class="p">,</span> <span class="n">gal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">gal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">single_galaxies</span> <span class="o">=</span> <span class="n">gal</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">gal_shape</span><span class="p">)</span>
        <span class="n">single_vars</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">gal_shape</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">single_galaxies</span><span class="p">,</span> <span class="n">single_vars</span>

    <span class="k">def</span> <span class="nf">_render_multiple_galaxies_on_ptile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locs</span><span class="p">,</span> <span class="n">galaxy_params</span><span class="p">,</span> <span class="n">galaxy_bool</span><span class="p">):</span>
        <span class="c1"># max_sources obtained from locs, allows for more flexibility when rendering.</span>
        <span class="n">n_ptiles</span> <span class="o">=</span> <span class="n">locs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_sources</span> <span class="o">=</span> <span class="n">locs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ptile_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_ptiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span><span class="p">)</span>
        <span class="n">ptile</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ptile_shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">locs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">var_ptile</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ptile_shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">locs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">galaxy_decoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">galaxy_params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">galaxy_bool</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_ptiles</span>
        <span class="k">assert</span> <span class="n">galaxy_params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">galaxy_bool</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_sources</span>
        <span class="k">assert</span> <span class="n">galaxy_params</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_galaxy_params</span>
        <span class="k">assert</span> <span class="n">galaxy_bool</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="n">single_galaxies</span><span class="p">,</span> <span class="n">single_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_single_galaxies</span><span class="p">(</span>
            <span class="n">galaxy_params</span><span class="p">,</span> <span class="n">galaxy_bool</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_sources</span><span class="p">):</span>
            <span class="n">galaxy_bool_n</span> <span class="o">=</span> <span class="n">galaxy_bool</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span>
            <span class="n">locs_n</span> <span class="o">=</span> <span class="n">locs</span><span class="p">[:,</span> <span class="n">n</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">_galaxy</span> <span class="o">=</span> <span class="n">single_galaxies</span><span class="p">[:,</span> <span class="n">n</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">_var</span> <span class="o">=</span> <span class="n">single_vars</span><span class="p">[:,</span> <span class="n">n</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="n">galaxy</span> <span class="o">=</span> <span class="n">_galaxy</span> <span class="o">*</span> <span class="n">galaxy_bool_n</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">_var</span> <span class="o">*</span> <span class="n">galaxy_bool_n</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">one_galaxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_one_source</span><span class="p">(</span><span class="n">locs_n</span><span class="p">,</span> <span class="n">galaxy</span><span class="p">)</span>
            <span class="n">one_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_one_source</span><span class="p">(</span><span class="n">locs_n</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
            <span class="n">ptile</span> <span class="o">+=</span> <span class="n">one_galaxy</span>
            <span class="n">var_ptile</span> <span class="o">+=</span> <span class="n">one_var</span>

        <span class="k">return</span> <span class="n">ptile</span><span class="p">,</span> <span class="n">var_ptile</span>

    <span class="k">def</span> <span class="nf">_render_ptiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_sources</span><span class="p">,</span> <span class="n">locs</span><span class="p">,</span> <span class="n">galaxy_bool</span><span class="p">,</span> <span class="n">galaxy_params</span><span class="p">,</span> <span class="n">fluxes</span><span class="p">):</span>
        <span class="c1"># n_sources: is (batch_size x n_tiles_per_image)</span>
        <span class="c1"># locs: is (batch_size x n_tiles_per_image x max_sources x 2)</span>
        <span class="c1"># galaxy_bool: Is (batch_size x n_tiles_per_image x max_sources)</span>
        <span class="c1"># galaxy_params : is (batch_size x n_tiles_per_image x max_sources x latent_dim)</span>
        <span class="c1"># fluxes: Is (batch_size x n_tiles_per_image x max_sources x 2)</span>

        <span class="c1"># returns the ptiles in</span>
        <span class="c1"># shape = (batch_size x n_tiles_per_image x n_bands x ptile_slen x ptile_slen)</span>
        <span class="n">max_sources</span> <span class="o">=</span> <span class="n">locs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">n_sources</span> <span class="o">&lt;=</span> <span class="n">max_sources</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">n_sources</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_ptiles</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_tiles_per_image</span>

        <span class="c1"># view parameters being explicit about shapes</span>
        <span class="n">_n_sources</span> <span class="o">=</span> <span class="n">n_sources</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_ptiles</span><span class="p">)</span>
        <span class="n">_locs</span> <span class="o">=</span> <span class="n">locs</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_ptiles</span><span class="p">,</span> <span class="n">max_sources</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">_galaxy_bool</span> <span class="o">=</span> <span class="n">galaxy_bool</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_ptiles</span><span class="p">,</span> <span class="n">max_sources</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">_fluxes</span> <span class="o">=</span> <span class="n">fluxes</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_ptiles</span><span class="p">,</span> <span class="n">max_sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span><span class="p">)</span>
        <span class="n">_galaxy_params</span> <span class="o">=</span> <span class="n">galaxy_params</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_ptiles</span><span class="p">,</span> <span class="n">max_sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_galaxy_params</span><span class="p">)</span>

        <span class="c1"># draw stars and galaxies</span>
        <span class="n">_is_on_array</span> <span class="o">=</span> <span class="n">get_is_on_from_n_sources</span><span class="p">(</span><span class="n">_n_sources</span><span class="p">,</span> <span class="n">max_sources</span><span class="p">)</span>
        <span class="n">_is_on_array</span> <span class="o">=</span> <span class="n">_is_on_array</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_ptiles</span><span class="p">,</span> <span class="n">max_sources</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">_star_bool</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_galaxy_bool</span><span class="p">)</span> <span class="o">*</span> <span class="n">_is_on_array</span>
        <span class="n">_star_bool</span> <span class="o">=</span> <span class="n">_star_bool</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">n_ptiles</span><span class="p">,</span> <span class="n">max_sources</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># final shapes of images.</span>
        <span class="n">img_shape</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_tiles_per_image</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_bands</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ptile_slen</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># draw stars and galaxies</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_multiple_stars_on_ptile</span><span class="p">(</span><span class="n">_locs</span><span class="p">,</span> <span class="n">_fluxes</span><span class="p">,</span> <span class="n">_star_bool</span><span class="p">)</span>
        <span class="n">galaxies</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">img_shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">locs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">var_images</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">img_shape</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">locs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">galaxy_decoder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">galaxies</span><span class="p">,</span> <span class="n">var_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_multiple_galaxies_on_ptile</span><span class="p">(</span>
                <span class="n">_locs</span><span class="p">,</span> <span class="n">_galaxy_params</span><span class="p">,</span> <span class="n">_galaxy_bool</span>
            <span class="p">)</span>

        <span class="n">images</span> <span class="o">=</span> <span class="n">galaxies</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">img_shape</span><span class="p">)</span> <span class="o">+</span> <span class="n">stars</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">img_shape</span><span class="p">)</span>
        <span class="n">var_images</span> <span class="o">=</span> <span class="n">var_images</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">img_shape</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">var_images</span>

    <span class="k">def</span> <span class="nf">render_images</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">n_sources</span><span class="p">,</span> <span class="n">locs</span><span class="p">,</span> <span class="n">galaxy_bool</span><span class="p">,</span> <span class="n">galaxy_params</span><span class="p">,</span> <span class="n">fluxes</span><span class="p">,</span> <span class="n">add_noise</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="c1"># returns the **full** image in shape (batch_size x n_bands x slen x slen)</span>

        <span class="c1"># n_sources: is (batch_size x n_tiles_per_image)</span>
        <span class="c1"># locs: is (batch_size x n_tiles_per_image x max_sources x 2)</span>
        <span class="c1"># galaxy_bool: Is (batch_size x n_tiles_per_image x max_sources x 1)</span>
        <span class="c1"># galaxy_params : is (batch_size x n_tiles_per_image x max_sources x latent_dim)</span>
        <span class="c1"># fluxes: Is (batch_size x n_tiles_per_image x max_sources x n_bands)</span>

        <span class="k">assert</span> <span class="n">n_sources</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">locs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">n_sources</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">locs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">galaxy_bool</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="c1"># first render the padded tiles</span>
        <span class="n">image_ptiles</span><span class="p">,</span> <span class="n">var_ptiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_render_ptiles</span><span class="p">(</span>
            <span class="n">n_sources</span><span class="p">,</span> <span class="n">locs</span><span class="p">,</span> <span class="n">galaxy_bool</span><span class="p">,</span> <span class="n">galaxy_params</span><span class="p">,</span> <span class="n">fluxes</span>
        <span class="p">)</span>

        <span class="c1"># render the image from padded tiles</span>
        <span class="n">images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_full_image_from_ptiles</span><span class="p">(</span>
            <span class="n">image_ptiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_slen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">border_padding</span>
        <span class="p">)</span>
        <span class="n">var_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_full_image_from_ptiles</span><span class="p">(</span>
            <span class="n">var_ptiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_slen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">border_padding</span>
        <span class="p">)</span>

        <span class="c1"># add background and noise</span>
        <span class="n">images</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">var_images</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_noise</span><span class="p">:</span>
            <span class="n">images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_noise</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">images</span><span class="p">,</span> <span class="n">var_images</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_construct_full_image_from_ptiles</span><span class="p">(</span><span class="n">image_ptiles</span><span class="p">,</span> <span class="n">tile_slen</span><span class="p">,</span> <span class="n">border_padding</span><span class="p">):</span>
        <span class="c1"># image_tiles is (batch_size, n_tiles_per_image, n_bands, ptile_slen x ptile_slen)</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">image_ptiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_tiles_per_image</span> <span class="o">=</span> <span class="n">image_ptiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">n_bands</span> <span class="o">=</span> <span class="n">image_ptiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ptile_slen</span> <span class="o">=</span> <span class="n">image_ptiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">image_ptiles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">ptile_slen</span>

        <span class="n">n_tiles1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_tiles_per_image</span><span class="p">)</span>
        <span class="c1"># check it is an integer</span>
        <span class="k">assert</span> <span class="n">n_tiles1</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">n_tiles1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_tiles1</span><span class="p">)</span>

        <span class="c1"># the number of tiles in ptile row</span>
        <span class="c1"># i.e the slen of a ptile but in units of tile_slen</span>
        <span class="n">n_tiles1_in_ptile</span> <span class="o">=</span> <span class="n">ptile_slen</span> <span class="o">/</span> <span class="n">tile_slen</span>
        <span class="n">n_tiles_of_padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_tiles1_in_ptile</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">n_tiles1_in_ptile</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">),</span> <span class="s2">&quot;tile_slen and ptile_slen are not compatible. check tile_slen argument&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">n_tiles_of_padding</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">),</span> <span class="s2">&quot;tile_slen and ptile_slen are not compatible. check tile_slen argument&quot;</span>
        <span class="n">n_tiles1_in_ptile</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_tiles1_in_ptile</span><span class="p">)</span>
        <span class="n">n_tiles_of_padding</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_tiles_of_padding</span><span class="p">)</span>

        <span class="n">image_tiles_4d</span> <span class="o">=</span> <span class="n">image_ptiles</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
            <span class="n">batch_size</span><span class="p">,</span> <span class="n">n_tiles1</span><span class="p">,</span> <span class="n">n_tiles1</span><span class="p">,</span> <span class="n">n_bands</span><span class="p">,</span> <span class="n">ptile_slen</span><span class="p">,</span> <span class="n">ptile_slen</span>
        <span class="p">)</span>

        <span class="c1"># zero pad tiles, so that the number of tiles in a row (and column)</span>
        <span class="c1"># are divisible by n_tiles1_in_ptile</span>
        <span class="n">n_tiles_pad</span> <span class="o">=</span> <span class="n">n_tiles1_in_ptile</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_tiles1</span> <span class="o">%</span> <span class="n">n_tiles1_in_ptile</span><span class="p">)</span>
        <span class="n">zero_pads1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="n">n_tiles_pad</span><span class="p">,</span>
            <span class="n">n_tiles1</span><span class="p">,</span>
            <span class="n">n_bands</span><span class="p">,</span>
            <span class="n">ptile_slen</span><span class="p">,</span>
            <span class="n">ptile_slen</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">image_ptiles</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">zero_pads2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="n">n_tiles1</span> <span class="o">+</span> <span class="n">n_tiles_pad</span><span class="p">,</span>
            <span class="n">n_tiles_pad</span><span class="p">,</span>
            <span class="n">n_bands</span><span class="p">,</span>
            <span class="n">ptile_slen</span><span class="p">,</span>
            <span class="n">ptile_slen</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">image_ptiles</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">image_tiles_4d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">image_tiles_4d</span><span class="p">,</span> <span class="n">zero_pads1</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">image_tiles_4d</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">image_tiles_4d</span><span class="p">,</span> <span class="n">zero_pads2</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># construct the full image</span>
        <span class="n">n_tiles</span> <span class="o">=</span> <span class="n">n_tiles1</span> <span class="o">+</span> <span class="n">n_tiles_pad</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">batch_size</span><span class="p">,</span>
            <span class="n">n_bands</span><span class="p">,</span>
            <span class="p">(</span><span class="n">n_tiles</span> <span class="o">+</span> <span class="n">n_tiles1_in_ptile</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tile_slen</span><span class="p">,</span>
            <span class="p">(</span><span class="n">n_tiles</span> <span class="o">+</span> <span class="n">n_tiles1_in_ptile</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tile_slen</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">image_ptiles</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># loop through all tiles in a ptile</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tiles1_in_ptile</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_tiles1_in_ptile</span><span class="p">):</span>
                <span class="n">indx_vec1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                    <span class="n">start</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                    <span class="n">end</span><span class="o">=</span><span class="n">n_tiles</span><span class="p">,</span>
                    <span class="n">step</span><span class="o">=</span><span class="n">n_tiles1_in_ptile</span><span class="p">,</span>
                    <span class="n">device</span><span class="o">=</span><span class="n">image_ptiles</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">indx_vec2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                    <span class="n">start</span><span class="o">=</span><span class="n">j</span><span class="p">,</span>
                    <span class="n">end</span><span class="o">=</span><span class="n">n_tiles</span><span class="p">,</span>
                    <span class="n">step</span><span class="o">=</span><span class="n">n_tiles1_in_ptile</span><span class="p">,</span>
                    <span class="n">device</span><span class="o">=</span><span class="n">image_ptiles</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">canvas_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx_vec1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ptile_slen</span>

                <span class="n">image_tile_rows</span> <span class="o">=</span> <span class="n">image_tiles_4d</span><span class="p">[:,</span> <span class="n">indx_vec1</span><span class="p">]</span>
                <span class="n">image_tile_cols</span> <span class="o">=</span> <span class="n">image_tile_rows</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">indx_vec2</span><span class="p">]</span>

                <span class="c1"># get canvas</span>
                <span class="n">canvas</span><span class="p">[</span>
                    <span class="p">:,</span>
                    <span class="p">:,</span>
                    <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">tile_slen</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">tile_slen</span> <span class="o">+</span> <span class="n">canvas_len</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">tile_slen</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">tile_slen</span> <span class="o">+</span> <span class="n">canvas_len</span><span class="p">),</span>
                <span class="p">]</span> <span class="o">+=</span> <span class="n">image_tile_cols</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="n">batch_size</span><span class="p">,</span> <span class="n">n_bands</span><span class="p">,</span> <span class="n">canvas_len</span><span class="p">,</span> <span class="n">canvas_len</span>
                <span class="p">)</span>

        <span class="c1"># trim to original image size</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">n_tiles_of_padding</span> <span class="o">*</span> <span class="n">tile_slen</span> <span class="o">-</span> <span class="n">border_padding</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_tiles1</span> <span class="o">+</span> <span class="n">n_tiles_of_padding</span><span class="p">)</span> <span class="o">*</span> <span class="n">tile_slen</span> <span class="o">+</span> <span class="n">border_padding</span>
        <span class="k">return</span> <span class="n">canvas</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">]</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">bliss</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">Bliss API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html#indices-and-tables">Indices and tables</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Probabilistic Machine Learning Research Group.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>